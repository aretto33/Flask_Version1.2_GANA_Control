{% extends "base.html" %}
{% block content %}

<style>
/* ===== GENERAL ===== */
.table-box {
    background:#f5e8d8;
    padding:20px;
    border-radius:12px;
}
table{ width:100%; border-collapse:collapse; }
th{ background:#d8c2a8; padding:8px; }
td{ border:1px solid #c4ab92; padding:8px; text-align:center; }

.btn{
    background:#8b5e3c;
    color:#fff;
    border:none;
    padding:6px 12px;
    border-radius:6px;
    cursor:pointer;
}
.btn:hover{ background:#6b452e; }
.btn-small{ font-size:.8rem; }
.btn-ver{ background:#3e6db5; }
.btn-ver:hover{ background:#305692; }

/* ===== MODAL FORM / VIEW ===== */
.modal-overlay{
    position:fixed;
    inset:0;
    background:rgba(0,0,0,.45);
    display:none;
    justify-content:center;
    align-items:center;
    z-index:9999;
}
.modal-card{
    background:#f5e8d8;
    padding:20px;
    border-radius:12px;
    max-width:600px;
    width:100%;
}
.close-btn{
    float:right;
    background:none;
    border:none;
    font-size:1.2rem;
    cursor:pointer;
}
input,select{
    width:100%;
    padding:8px;
    border-radius:6px;
    border:1px solid #bca58b;
    margin-bottom:10px;
}
</style>

<h2>Gestión de Predios</h2>

<button class="btn" onclick="abrirForm()"> Registrar Predio</button>

<!-- ===== TABLA ===== -->
<div class="table-box">
    <h3>Predios Registrados</h3>
    <table>
        <tr>
            <th>ID</th><th>Dirección</th><th>Estado</th>
            <th>Municipio</th><th>Productor</th><th>Rancho</th>
            <th>Acciones</th>
        </tr>
        {% for p in predios %}
        <tr>
            <td>{{ p[0] }}</td>
            <td>{{ p[1] }}</td>
            <td>{{ p[4] }}</td>
            <td>{{ p[5] }}</td>
            <td>{{ p[7] or '—' }}</td>
            <td>{{ p[8] or '—' }}</td>
            <td>
    <button class="btn btn-small btn-ver"
        onclick='verPredio({{ {
            "id":p[0], "direccion":p[1],
            "estado":p[4], "municipio":p[5],
            "productor":p[7], "rancho":p[8],
            "fk_estado":p[2], "fk_municipio":p[3]
        } | tojson }})'>Ver</button>

    <button class="btn btn-small"
        onclick='editarPredio({{
            {"id":p[0],"direccion":p[1],
             "fk_estado":p[2],"fk_municipio":p[3]}
            | tojson
        }})'>Modificar</button>

    <button class="btn btn-small"
        style="background:#b53e3e"
        onclick="eliminarPredio({{ p[0] }})">
        Eliminar
    </button>
</td>

        </tr>
        {% endfor %}
    </table>
</div>

<!-- ===== MODAL FORM ===== -->
<div id="modalForm" class="modal-overlay">
    <div class="modal-card">
        <button class="close-btn" onclick="cerrar()">✕</button>
        <h3 id="formTitle">Registrar Predio</h3>

        <form method="POST" id="predioForm">
            <input type="hidden" name="pk" id="f_pk">

            <label>Dirección</label>
            <input type="text" name="direccion" id="f_direccion" required>

            <label>Estado</label>
            <select name="fk_estado" id="f_estado" required>
                <option value="">Seleccione…</option>
                {% for e in estados %}
                <option value="{{ e[0] }}">{{ e[1] }}</option>
                {% endfor %}
            </select>

            <label>Municipio</label>
            <select name="fk_municipio" id="f_municipio" required>
                <option value="">Seleccione…</option>
                {% for m in municipios %}
                <option value="{{ m[0] }}" data-estado="{{ m[2] }}">{{ m[1] }}</option>
                {% endfor %}
            </select>

            {% if session.get('rol')=='Productor' %}
                <input type="hidden" name="fk_productor" value="{{ session.get('fk_productor') }}">
            {% else %}
                <label>Productor</label>
                <select name="fk_productor">
                    {% for p in productores %}
                    <option value="{{ p[0] }}">{{ p[1] }}</option>
                    {% endfor %}
                </select>
            {% endif %}

            <button class="btn" name="accion" value="registrar" id="btnAccion">
                Guardar
            </button>
        </form>
    </div>
</div>

<!-- ===== MODAL VER ===== -->
<div id="modalVer" class="modal-overlay">
    <div class="modal-card">
        <button class="close-btn" onclick="cerrar()">✕</button>
        <h3>Detalle del Predio</h3>
        <p><b>ID:</b> <span id="v_id"></span></p>
        <p><b>Dirección:</b> <span id="v_dir"></span></p>
        <p><b>Estado:</b> <span id="v_estado"></span></p>
        <p><b>Municipio:</b> <span id="v_municipio"></span></p>
        <p><b>Productor:</b> <span id="v_productor"></span></p>
        <p><b>Rancho:</b> <span id="v_rancho"></span></p>

        <button class="btn" onclick="editarDesdeVer()">Modificar</button>
    </div>
</div>

<script>
let actual=null;

function abrirForm(){
    document.getElementById("predioForm").reset();
    document.getElementById("f_pk").value="";
    document.getElementById("formTitle").innerText="Registrar Predio";
    document.getElementById("btnAccion").value="registrar";
    document.getElementById("modalForm").style.display="flex";
}

function editarPredio(o){
    actual=o;
    document.getElementById("f_pk").value=o.id;
    document.getElementById("f_direccion").value=o.direccion;
    document.getElementById("f_estado").value=o.fk_estado;
    filtrar(o.fk_estado);
    setTimeout(()=>f_municipio.value=o.fk_municipio,50);
    document.getElementById("formTitle").innerText="Modificar Predio";
    document.getElementById("btnAccion").value="modificar";
    document.getElementById("modalForm").style.display="flex";
}

function verPredio(o){
    actual=o;
    v_id.innerText=o.id;
    v_dir.innerText=o.direccion;
    v_estado.innerText=o.estado;
    v_municipio.innerText=o.municipio;
    v_productor.innerText=o.productor||'—';
    v_rancho.innerText=o.rancho||'—';
    modalVer.style.display="flex";
}

function editarDesdeVer(){
    cerrar();
    editarPredio(actual);
}

function cerrar(){
    modalForm.style.display="none";
    modalVer.style.display="none";
}

function filtrar(id){
    document.querySelectorAll("#f_municipio option").forEach(o=>{
        o.hidden=o.value && o.dataset.estado!=id;
    });
}
f_estado.addEventListener("change",e=>filtrar(e.target.value));

document.addEventListener("keydown",e=>{ if(e.key==="Escape") cerrar(); });

function eliminarPredio(id){
    if(!confirm("¿Deseas eliminar este predio?\nEsta acción no se puede deshacer.")) {
        return;
    }

    const form = document.createElement("form");
    form.method = "POST";
    form.style.display = "none";

    form.innerHTML = `
        <input type="hidden" name="accion" value="eliminar">
        <input type="hidden" name="pk" value="${id}">
    `;

    document.body.appendChild(form);
    form.submit();
}
</script>

{% endblock %}
