{% extends "base.html" %}
{% block content %}

<style>
/* ===== GENERAL ===== */
.table-box{
    background:#f5e8d8;
    padding:20px;
    border-radius:12px;
}
table{ width:100%; border-collapse:collapse; }
th{ background:#d8c2a8; padding:8px; }
td{
    border:1px solid #c4ab92;
    padding:8px;
    text-align:center;
}

.btn{
    background:#8b5e3c;
    color:#fff;
    border:none;
    padding:6px 12px;
    border-radius:6px;
    cursor:pointer;
}
.btn:hover{ background:#6b452e; }
.btn-small{ font-size:.8rem; }
.btn-ver{ background:#3e6db5; }
.btn-ver:hover{ background:#305692; }

/* ===== MODAL ===== */
.modal-overlay{
    position:fixed;
    inset:0;
    background:rgba(0,0,0,.45);
    display:none;
    justify-content:center;
    align-items:center;
    z-index:9999;
}
.modal-card{
    background:#f5e8d8;
    padding:20px;
    border-radius:12px;
    max-width:600px;
    width:100%;
}
.close-btn{
    float:right;
    background:none;
    border:none;
    font-size:1.2rem;
    cursor:pointer;
}
input,select{
    width:100%;
    padding:8px;
    border-radius:6px;
    border:1px solid #bca58b;
    margin-bottom:10px;
}
.banner{
    width:100%;
    max-width:1300px;
    margin:20px auto;
    display:block;
    border-radius:12px;
}
</style>

<img src="{{ url_for('static', filename='img/4.png') }}" class="banner">

<h2>ðŸ©º Seguimiento Veterinario</h2>

<button class="btn" onclick="abrirForm()">âž• Registrar Seguimiento</button>

<!-- ===== TABLA ===== -->
<div class="table-box">
    <h3>Registros</h3>
    <table>
        <tr>
            <th>ID</th>
            <th>Animal</th>
            <th>Tratamiento</th>
            <th>Fecha Actual</th>
            <th>PrÃ³xima Fecha</th>
            <th>Acciones</th>
        </tr>

        {% for s in seguimientos %}
        <tr>
            <td>{{ s[0] }}</td>
            <td>{{ s[1] }}</td>
            <td>{{ s[2] }}</td>
            <td>{{ s[3] }}</td>
            <td>{{ s[4] or 'â€”' }}</td>
            <td>
                <button class="btn btn-small"
                    onclick='editar({{
                        {"id":s[0],"animal":s[1],
                         "tratamiento":s[2],
                         "fechaA":s[3],
                         "fechaP":s[4]}
                         | tojson
                    }})'>
                    Modificar
                </button>

                <button class="btn btn-small"
                    style="background:#b53e3e"
                    onclick="eliminar({{ s[0] }})">
                    Eliminar
                </button>
            </td>
        </tr>
        {% endfor %}
    </table>
</div>

<!-- ===== MODAL FORM ===== -->
<div id="modalForm" class="modal-overlay">
    <div class="modal-card">
        <button class="close-btn" onclick="cerrar()">âœ•</button>
        <h3 id="formTitle">Registrar Seguimiento</h3>

        <form method="POST" id="segForm">
            <input type="hidden" name="pk" id="f_pk">

            <label>Animal</label>
            <select name="fk_animal" id="f_animal" required>
                <option value="">Seleccioneâ€¦</option>
                {% for a in animales %}
                <option value="{{ a[0] }}">{{ a[0] }} - {{ a[1] }}</option>
                {% endfor %}
            </select>

            <label>Tipo de Tratamiento</label>
            <input type="text" name="tipo_tratamiento" id="f_trat" required>

            <label>Fecha Actual</label>
            <input type="date" name="fecha_actual" id="f_fechaA" required>

            <label>PrÃ³xima Fecha</label>
            <input type="date" name="prox_fecha" id="f_fechaP">

            <button class="btn" name="accion" id="btnAccion" value="registrar">
                Guardar
            </button>
        </form>
    </div>
</div>

<script>
let actual=null;

function abrirForm(){
    segForm.reset();
    f_pk.value="";
    formTitle.innerText="Registrar Seguimiento";
    btnAccion.value="registrar";
    modalForm.style.display="flex";
}

function editar(o){
    actual=o;
    f_pk.value=o.id;
    f_animal.value=o.animal;
    f_trat.value=o.tratamiento;
    f_fechaA.value=o.fechaA;
    f_fechaP.value=o.fechaP;

    formTitle.innerText="Modificar Seguimiento";
    btnAccion.value="modificar";
    modalForm.style.display="flex";
}

function cerrar(){
    modalForm.style.display="none";
}

function eliminar(id){
    if(!confirm("Â¿Eliminar este seguimiento?")) return;

    const f=document.createElement("form");
    f.method="POST";
    f.style.display="none";
    f.innerHTML=`
        <input name="accion" value="eliminar">
        <input name="pk" value="${id}">
    `;
    document.body.appendChild(f);
    f.submit();
}

document.addEventListener("keydown",e=>{
    if(e.key==="Escape") cerrar();
});
</script>

{% endblock %}
