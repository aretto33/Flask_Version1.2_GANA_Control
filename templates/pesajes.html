{% extends "base.html" %}
{% block content %}

<div class="pesajes-module">
<style>
.pesajes-module h2{
    margin-bottom:15px;
    color:#5a3a22;
}

/* ===== CONTENEDORES ===== */
.pesajes-module .box{
    background:#f5e8d8;
    padding:20px;
    border-radius:12px;
    margin-bottom:25px;
    box-shadow:0 4px 10px rgba(0,0,0,.1);
}

/* ===== TABLA ===== */
.pesajes-module table{
    width:100%;
    border-collapse:collapse;
}
.pesajes-module th{
    background:#d8c2a8;
    padding:10px;
    color:#4a2f1a;
}
.pesajes-module td{
    background:#efe1cf;          /* ← café claro, ya NO blanco */
    border:1px solid #c4ab92;
    padding:8px;
    text-align:center;
    color:#4a2f1a;
}

/* ===== BOTONES ===== */
.pesajes-module .btn{
    background:#8b5e3c;
    color:#fff;
    border:none;
    padding:6px 12px;
    border-radius:6px;
    cursor:pointer;
}
.pesajes-module .btn:hover{
    background:#6b452e;
}
.pesajes-module .btn-ver{
    background:#7a93c9;          /* azul suave que combina */
}
.pesajes-module .btn-ver:hover{
    background:#5f77aa;
}
.pesajes-module .btn-del{
    background:#a14a3a;
}

/* ===== FORM ===== */
.pesajes-module input,
.pesajes-module select{
    width:100%;
    padding:8px;
    border-radius:6px;
    border:1px solid #bca58b;
    margin-bottom:10px;
    background:#f3e6d6;          /* ← café claro */
    color:#4a2f1a;
}
.pesajes-module input:focus,
.pesajes-module select:focus{
    outline:none;
    border-color:#8b5e3c;
}

/* ===== MODAL ===== */
.pesajes-module .overlay{
    position:fixed;
    inset:0;
    background:rgba(0,0,0,.45);
    display:none;
    justify-content:center;
    align-items:center;
    z-index:9999;
}
.pesajes-module .card{
    background:#f5e8d8;          /* ← mismo color que cajas */
    padding:20px;
    border-radius:12px;
    min-width:380px;
    box-shadow:0 10px 26px rgba(0,0,0,.35);
}
.pesajes-module .card p,
.pesajes-module .card h4{
    color:#4a2f1a;
}
.pesajes-module .close{
    float:right;
    background:none;
    border:none;
    font-size:1.2rem;
    cursor:pointer;
    color:#5a3a22;
}
</style>


<h2>Gestión de Pesajes</h2>

<button class="btn" onclick="abrirForm()">➕ Registrar Pesaje</button>

<!-- ===== TABLA ===== -->
<div class="box">
    <h3>Pesajes Registrados</h3>
    <h4>Total: {{ pesajes|length }}</h4> <!-- Hace el conteo de los pesajes en la tabla -->

    <table>
        <tr>
            <th>ID</th>
            <th>Peso (kg)</th>
            <th>Fecha</th>
            <th>Animal</th>
            <th>Acciones</th>
        </tr>

        {% for p in pesajes %}
        <tr>
            <td>{{ p[0] }}</td>
            <td>{{ p[1] }}</td>
            <td>{{ p[2] }}</td>
            <td>{{ p[4] or '—' }} ({{ p[3] or '—' }})</td>
            <td>
                <button class="btn btn-ver btn-small"
                    onclick='verPesaje({{ {
                        "id":p[0],"peso":p[1],"fecha":p[2],
                        "fk_animal":p[3],"animal":p[4]
                    } | tojson }})'>Ver</button>

                <button class="btn btn-small"
                    onclick='editarPesaje({{
                        {"id":p[0],"peso":p[1],
                         "fecha":p[2],"fk_animal":p[3]}
                        | tojson
                    }})'>Modificar</button>

                <form method="POST" style="display:inline">
                    <input type="hidden" name="pk" value="{{ p[0] }}">
                    <button class="btn btn-small btn-del"
                        name="accion" value="eliminar"
                        onclick="return confirm('¿Eliminar este pesaje?')">
                        Eliminar
                    </button>
                </form>
            </td>
        </tr>
        {% endfor %}
    </table>
</div>

<!-- ===== MODAL FORM ===== -->
<div id="modalForm" class="overlay">
    <div class="card">
        <button class="close" onclick="cerrar()">✕</button>
        <h3 id="titulo">Registrar Pesaje</h3>

        <form method="POST">
            <input type="hidden" name="pk" id="f_pk">

            <label>Peso (kg)</label>
            <input type="number" step="0.1" name="pesaje" id="f_peso" required>

            <label>Fecha</label>
            <input type="date" name="fecha" id="f_fecha" required>

            <label>Animal</label>
            <select name="fk_animal" id="f_animal" required>
                <option value="">Seleccione…</option>
                {% for a in animales %}
                <option value="{{ a[0] }}">{{ a[1] }}</option>
                {% endfor %}
            </select>

            <button class="btn" name="accion" id="accion" value="registrar">
                Guardar
            </button>
        </form>
    </div>
</div>

<!-- ===== MODAL VER ===== -->
<div id="modalVer" class="overlay">
    <div class="card">
        <button class="close" onclick="cerrar()">✕</button>
        <h3>Detalle del Pesaje</h3>
        <p><b>ID:</b> <span id="v_id"></span></p>
        <p><b>Peso:</b> <span id="v_peso"></span> kg</p>
        <p><b>Fecha:</b> <span id="v_fecha"></span></p>
        <p><b>Animal:</b> <span id="v_animal"></span></p>

        <button class="btn" onclick="editarDesdeVer()">Modificar</button>
    </div>
</div>

<script>
let actual=null;

function abrirForm(){
    document.querySelector("form").reset();
    f_pk.value="";
    accion.value="registrar";
    titulo.innerText="Registrar Pesaje";
    modalForm.style.display="flex";
}

function editarPesaje(o){
    actual=o;
    f_pk.value=o.id;
    f_peso.value=o.peso;
    f_fecha.value=o.fecha;
    f_animal.value=o.fk_animal;
    accion.value="modificar";
    titulo.innerText="Modificar Pesaje";
    modalForm.style.display="flex";
}

function verPesaje(o){
    actual=o;
    v_id.innerText=o.id;
    v_peso.innerText=o.peso;
    v_fecha.innerText=o.fecha;
    v_animal.innerText=o.animal || '—';
    modalVer.style.display="flex";
}

function editarDesdeVer(){
    cerrar();
    editarPesaje(actual);
}

function cerrar(){
    modalForm.style.display="none";
    modalVer.style.display="none";
}
</script>

</div>
{% endblock %}
